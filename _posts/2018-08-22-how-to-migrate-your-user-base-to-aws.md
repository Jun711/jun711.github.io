---
layout: single
title: 'How to migrate your user base to #aws #cognito? #AwsAmplify'
date: '2018-08-22T22:56:00.006-07:00'
categories: AWS
tags:
- cognito
- aws
---

<h3><span style="font-family: &quot;amazon ember&quot; , &quot;helvetica neue&quot; , &quot;roboto&quot; , &quot;arial&quot; , sans-serif;"><span style="background-color: white; font-size: 14px;">AWS Cognito User Migration</span></span></h3><div><span style="font-family: &quot;amazon ember&quot; , &quot;helvetica neue&quot; , &quot;roboto&quot; , &quot;arial&quot; , sans-serif;"><span style="background-color: white; font-size: 14px;">Thinking of switching over to user aws cognito to manage your user pool and authenticate your users, there are multiple ways to migrate your users to <a href="https://aws.amazon.com/cognito/" target="_blank">aws cognito</a>. In my opinion, user migration should occur in a way that introduces the least effort from the users. Check out these 3 ways:<br />i) upload your users <a href="https://docs.aws.amazon.com/en_us/cognito/latest/developerguide/cognito-user-pools-using-import-tool-csv-header.html" target="_blank">using a csv file</a><br />ii) use <a href="https://docs.aws.amazon.com/cognito-user-identity-pools/latest/APIReference/API_AdminCreateUser.html" target="_blank">admin_create_user</a>&nbsp;API</span></span><br /><span style="font-family: &quot;amazon ember&quot; , &quot;helvetica neue&quot; , &quot;roboto&quot; , &quot;arial&quot; , sans-serif;"><span style="background-color: white; font-size: 14px;">iii) write a <a href="https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-pools-import-using-lambda.html" target="_blank">user migration lambda trigger</a></span></span><br /><span style="font-family: &quot;amazon ember&quot; , &quot;helvetica neue&quot; , &quot;roboto&quot; , &quot;arial&quot; , sans-serif;"><span style="background-color: white; font-size: 14px;">There could be more ways but I am only aware of these 3 at the moment.&nbsp;</span></span><br /><h4><span style="font-family: &quot;amazon ember&quot; , &quot;helvetica neue&quot; , &quot;roboto&quot; , &quot;arial&quot; , sans-serif;"><span style="background-color: white; font-size: 14px;">Method 1: Upload using a csv file</span></span></h4><span style="font-family: &quot;amazon ember&quot; , &quot;helvetica neue&quot; , &quot;roboto&quot; , &quot;arial&quot; , sans-serif;"><span style="background-color: white; font-size: 14px;">1) Download a header file<br />2) Write a script to query your database and prep the user csv file</span></span><br /><span style="font-family: &quot;amazon ember&quot; , &quot;helvetica neue&quot; , &quot;roboto&quot; , &quot;arial&quot; , sans-serif;"><span style="background-color: white; font-size: 14px;">3) Upload the csv file on aws cognito console</span></span><br /><span style="font-family: &quot;amazon ember&quot; , &quot;helvetica neue&quot; , &quot;roboto&quot; , &quot;arial&quot; , sans-serif;"><span style="background-color: white; font-size: 14px;">There is a header file for all the fields that you optionally or mandatorily have to fill out.&nbsp;</span></span><br /><span style="font-family: &quot;amazon ember&quot; , &quot;helvetica neue&quot; , &quot;roboto&quot; , &quot;arial&quot; , sans-serif;"><span style="background-color: white; font-size: 14px;">To get this header file: aws console &gt; cognito &gt; users and groups (left hand side under general settings) &gt; on Users tab &gt; click Import Users &gt; Download CSV header<br /><br />This is also where you upload your user csv file if you upload it using aws cognito console. You can check out this <a href="https://docs.aws.amazon.com/en_us/cognito/latest/developerguide/cognito-user-pools-creating-import-job.html" target="_blank">aws doc</a>&nbsp;if you prefer to upload using aws cli.<br /><br />Check out an example of header (taken from <a href="https://docs.aws.amazon.com/en_us/cognito/latest/developerguide/cognito-user-pools-using-import-tool-csv-header.html" target="_blank">aws doc</a>):&nbsp;</span></span><br /><!--?xml version="1.0" encoding="UTF-8"?-->  <br /><div style="-en-codeblock: true; background-color: #fbfaf8; border-bottom-left-radius: 4px; border-bottom-right-radius: 4px; border-top-left-radius: 4px; border-top-right-radius: 4px; border: 1px solid rgba(0, 0, 0, 0.14902); box-sizing: border-box; color: #333333; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; padding: 8px;"><span style="color: black; font-family: &quot;amazon ember&quot; , &quot;helvetica neue&quot; , &quot;roboto&quot; , &quot;arial&quot; , sans-serif; font-size: 14px;">cognito:username,name,given_name,family_name,middle_name,nickname,preferred_username,profile,picture,website,email,email_verified,gender,birthdate,zoneinfo,locale,phone_number,phone_number_verified,address,updated_at,cognito:mfa_enabled</span></div><br />The headers could be different depending on custom fields that you have added.<br /><br />Note:<br />i)&nbsp;Remember that the uploaded users will have a status of RESET_REQUIRED, which means, the users have to reset their password in order to log in successfully at the first time. So, it would require a redirection flow on the login process.<br /><br />ii) This actually has a log on CloudWatch. You can use it to check the error messages in case your user import job isn't executed successfully.<br />To view the log on CloudWatch, follow the following steps:<br />CloudWatch &gt; Logs on left side panel &gt; filter for /aws/cognito/ &gt; click on the user group &gt; look for your import job name<br /><h4>Method 1 Troubleshooting</h4><span style="font-family: &quot;amazon ember&quot; , &quot;helvetica neue&quot; , &quot;roboto&quot; , &quot;arial&quot; , sans-serif;"><span style="background-color: white; font-size: 14px;">If you have been wondering why your csv upload to cognito user has been failed even though you follow this&nbsp;<a href="http://docs.aws.amazon.com/en_us/cognito/latest/developerguide/cognito-user-pools-using-import-tool-csv-header.html" target="_blank">AWS Creating the User Import .csv File document</a>&nbsp;closely. You could be facing the same problems that I had.</span></span><br /><div><span style="font-family: &quot;amazon ember&quot; , &quot;helvetica neue&quot; , &quot;roboto&quot; , &quot;arial&quot; , sans-serif;"><span style="background-color: white; font-size: 14px;"><br /></span></span></div>Problems that I faced:</div>i) I didn't know both email_verified or phone_number_verified are required to be filled. On the document, it says OR. Thus, I only filled out email_verified as I use emails for login. Remember to fill out both fields.<br /><br />ii) This seems to be a UI problem of cognito console. The IAM name drop-down list seems to be cut off after 50 or so. In case your role name is ordered alphabetically after that specific count that can be seen from the drop down list, you won't be able to select your user-import role.<br />Thus, recreate another role and have its name start with 'a'.<br /><br />iii) I didn't know there is a limit of 50 uploads. I used up all my upload allocation and had to request for an increase. If you only upload a few users under scenarios such as a few users were failed to be uploaded or other reasons, you should use admin_create_user API.<br /><h4>Method 2:&nbsp;<a href="https://docs.aws.amazon.com/cognito-user-identity-pools/latest/APIReference/API_AdminCreateUser.html" target="_blank">Admin_create_user API</a></h4>1) Write a script to query your database to retrieve your users and use admin_create_user api to create a user in aws cognito<br /><br />Note: <br />i) If you write a python script to create users this way, it would take an amount of time directly proportional to the number of user base as it creates a user at a time. This seems to be a preferred way to use when you want to upload just a few users.<br /><br />ii) If you don't want aws to send a message to your users, please remember to set the SUPPRESS for MessageAction parameter.<br /><br />iii) Users created under this way will have a status of FORCE_CHANGE_PASSWORD. This means it requires a specific user login flow.<br />user logs in using a temporary password set by you / generated by aws<br />&gt; user resets password (using <a href="https://aws-amplify.github.io/amplify-js/api/classes/authclass.html" target="_blank">Amplify Auth</a>, it would be <a href="https://aws-amplify.github.io/amplify-js/api/classes/authclass.html#completenewpassword" target="_blank">completeNewPassword</a>&nbsp;API)<br /><br />If you wonder how many user status there could be, you can check out this <a href="https://docs.aws.amazon.com/cognito-user-identity-pools/latest/APIReference/API_AdminGetUser.html#API_AdminGetUser_ResponseSyntax" target="_blank">aws cognito doc</a><br /><div>Possible statuses:&nbsp;</div><div style="-en-codeblock: true; background-color: #fbfaf8; border-bottom-left-radius: 4px; border-bottom-right-radius: 4px; border-top-left-radius: 4px; border-top-right-radius: 4px; border: 1px solid rgba(0, 0, 0, 0.14902); box-sizing: border-box; color: #333333; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; padding: 8px;"><span style="font-family: &quot;monaco&quot;;">UNCONFIRMED | CONFIRMED | ARCHIVED | COMPROMISED | UNKNOWN | RESET_REQUIRED | FORCE_CHANGE_PASSWORD</span></div><span style="font-weight: normal;"><br /></span> <span style="font-weight: normal;">iv) Note that using this method and method 3, you can execute other logic such as adding your users to a cognito group, for example.&nbsp;</span><br /><h4>Method 3: User migration lambda</h4>This user migration lambda is triggered via user login(UserMigration_Authentication) and forgot password flow(UserMigration_ForgotPassword). This seems to introduce the least interruption to the login flow. <br /><br />You can check out these aws documents for more detailed information:<br />i)&nbsp;<a href="https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-pools-import-using-lambda.html" target="_blank">Importing Users into User Pools With a User Migration Lambda Trigger</a><br />ii)&nbsp;<a href="https://docs.aws.amazon.com/cognito/latest/developerguide/user-pool-lambda-migrate-user.html" target="_blank">Migrate User Lambda Trigger</a><br />iii)&nbsp;<a href="https://aws.amazon.com/blogs/mobile/migrating-users-to-amazon-cognito-user-pools/" target="_blank">Migrating Users to Amazon Cognito User Pools</a> by aws mobile<br /><br /><div style="-en-clipboard: true;">The Node.js code snippet below which is taken from the second aws document above gives an outline of your code for user migration lambda should be.<br />Note that authenticateUser function should be replaced by your own user authentication code.&nbsp;</div><div style="-en-clipboard: true;"><br /></div><div style="-en-clipboard: true;">in Node.js</div><div style="-en-codeblock: true; background-color: #fbfaf8; border-bottom-left-radius: 4px; border-bottom-right-radius: 4px; border-top-left-radius: 4px; border-top-right-radius: 4px; border: 1px solid rgba(0, 0, 0, 0.14902); box-sizing: border-box; color: #333333; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; padding: 8px;"><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">exports.handler = (event, context, callback) =&gt; {</span></div><div><br style="color: #333333; font-family: Monaco; font-size: 12px;" /></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;var user;</span></div><div><br style="color: #333333; font-family: Monaco; font-size: 12px;" /></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;if ( event.triggerSource == "UserMigration_Authentication" ) {</span></div><div><br style="color: #333333; font-family: Monaco; font-size: 12px;" /></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// authenticate the user with your existing user directory service</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;user = authenticateUser(event.userName, event.request.password);</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( user ) {</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;event.response.userAttributes = {</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"email": user.emailAddress,</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"email_verified": "true"</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;event.response.finalUserStatus = "CONFIRMED";</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;event.response.messageAction = "SUPPRESS";</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.succeed(event);</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else {</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Return error to Amazon Cognito</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callback("Bad password");</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;else if ( event.triggerSource == "UserMigration_ForgotPassword" ) {</span></div><div><br style="color: #333333; font-family: Monaco; font-size: 12px;" /></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Lookup the user in your existing user directory service</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;user = lookupUser(event.userName);</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if ( user ) {</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;event.response.userAttributes = {</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"email": user.emailAddress,</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// required to enable password-reset code to be sent to user</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"email_verified": "true"&nbsp;&nbsp;</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;event.response.messageAction = "SUPPRESS";</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;context.succeed(event);</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else {</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Return error to Amazon Cognito</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callback("Bad password");</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;else {</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// Return error to Amazon Cognito</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;callback("Bad triggerSource " + event.triggerSource);</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;}</span></div><div><span style="color: #333333; font-family: &quot;monaco&quot;; font-size: 12px;">};</span></div></div><!--?xml version="1.0" encoding="UTF-8"?-->  <br /><div><br />Note:<br />1) At the moment when I did user migration, Amplify library didn't support&nbsp;USER_PASSWORD_AUTH flow. It was default to USER_SRP_AUTH authentication flow.<br /><br />If you are interested in reading more about that, you can check out this list of&nbsp;<a href="https://github.com/aws-amplify/amplify-js/issues?utf8=%E2%9C%93&amp;q=USER_PASSWORD_AUTH" target="_blank">Amplify Github USER_PASSWORD_AUTH issues</a>.<br />This is the&nbsp;<a href="https://github.com/aws-amplify/amplify-js/issues/419" target="_blank">Amplify GitHub user authentication issue</a>&nbsp;that I participated in.<br /><br />2) As of now, feel free to use Amplify to do it as this feature has been included after this&nbsp;<a href="https://github.com/aws-amplify/amplify-js/pull/1033" target="_blank">Amplify pull request #1033</a>.<br /><h4>List Users</h4><div>Note that it wouldn't be as easy to filter for your users or query for your users once they are in Cognito compared to using a database.<br /><br />1) You can search for your users using aws cognito console. For example, you can search for a user using their email.<br /><br />2)&nbsp; You can list and filter your users using&nbsp;<a href="https://docs.aws.amazon.com/cognito-user-identity-pools/latest/APIReference/API_ListUsers.html" target="_blank">Amazon Cognito Identity Provider ListUsers API</a>. <br />Note that it returns a maximum of 60 users. And, you can only filter to the following list of attributes but not custom attributes</div><div><div><ul><li>username (case-sensitive)</li><li>email</li><li>phone_number</li><li>name</li><li>given_name</li><li>family_name</li><li>preferred_username</li><li>cognito:user_status (called Status in the Console) (case-insensitive)</li><li>status (called Enabled in the Console) (case-sensitive)</li><li>sub</li></ul></div></div><h4>Summary</h4>I uploaded my users using csv files and use admin_create_user in lambda to handle edge cases. This way provides security as when I am ready to switch over to cognito, I know my users are already in the cognito. I don't have to worry about migration failure or edge cases.&nbsp;</div><div><br /></div>Thanks for reading!<br /><a href="http://www.language-diary.com/p/jun711-language-diary.html" target="_blank">Jun</a><br /><br />