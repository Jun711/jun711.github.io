---
layout: single
title: 'Turn #XMLHttpRequest into a #Promise #XHR'
date: '2018-12-04T22:30:00.000-08:00'
categories: Web
tags:
- JavaScript
- Promise
---

<a href="http://www.language-diary.com/p/jun711-language-diary.html" target="_blank">By Jun</a> - <a href="https://www.amazon.ca/?&amp;_encoding=UTF8&amp;tag=jun7110a-20&amp;linkCode=ur2&amp;linkId=60b74555f1611d644d27d8b13f8b9418&amp;camp=15121&amp;creative=330641" target="_blank">Support me on Amazon Canada</a><br /><br />How to turn XMLHttpRequest / XHR into a Promise so that you can chain it with other promises?<br /><br />First of all, if you don't know what XMLHttpRequest is, you can check out <a href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest" target="_blank">MDN document on XMLHttpRequest</a>. In short, it is an API that can be used by&nbsp;a JavaScript to communicate to servers. It enables asynchronous HTTP requests.<br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://4.bp.blogspot.com/-3g8rNs5v2_I/XAeckI3h_DI/AAAAAAAAJgE/udmndKeL3O0CxWrNUkhIDbw-JQ3nuu2DgCLcBGAs/s1600/xhr-ready-states-chart-and-explanation.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img alt="XMLHttpRequest Ready States" border="0" data-original-height="808" data-original-width="1055" height="490" src="https://4.bp.blogspot.com/-3g8rNs5v2_I/XAeckI3h_DI/AAAAAAAAJgE/udmndKeL3O0CxWrNUkhIDbw-JQ3nuu2DgCLcBGAs/s640/xhr-ready-states-chart-and-explanation.png" title="XHR Ready States" width="640" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">XMLHttpRequest Ready States</td></tr></tbody></table><h4><br />Situation:</h4>You might wonder why not using <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/fetch" target="_blank">Fetch (definition on MDN)</a> which is the new way of fetching data&nbsp; asynchronously from servers. Well, they work quite similarly but not exactly the same.&nbsp;I am not sure about how many cases there are but there is this case that I have to use XHR instead of Fetch.<br /><h4>Issues that I faced:</h4>Using fetch for a cross origin request(url is set in the permission in manifest) in chrome extension set origin header as null and doesn't sell referer header in the request. <br />Thus, I cannot use origin and referer header to identify if a request is coming from my chrome extension.<br />i)&nbsp;<a href="https://stackoverflow.com/questions/45222298/using-fetch-in-chrome-extension-sends-null-origin-header" target="_blank">Using fetch in chrome extension sends null origin header StackOverflow thread</a><br />ii)&nbsp;<a href="https://stackoverflow.com/questions/53627310/using-fetch-in-chrome-extension-doesnt-include-referer-header-in-the-request" target="_blank">Using fetch in chrome extension doesn't include referer header in the request StackOverflow thread</a><br /><br />As a result, I have to use XHR to do it.<br /><h4>How to turn XMLHttpRequest / XHR into a promise?</h4>This is an example of how you can return a Promise that contains an XMLHttpRequest.<br /><div style="-en-clipboard: true;"><br /></div><!--?xml version="1.0" encoding="UTF-8"?-->  <br /><div style="background-color: #fbfaf8; border-radius: 4px; border: 1px solid rgba(0, 0, 0, 0.15); box-sizing: border-box; padding: 8px;"><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">function xhr(params) {</div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;<b>return new Promise(function(resolve, reject) { </b></div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;let xhr = new XMLHttpRequest(); </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;let url = '';</div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;"><br /></div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;xhr.open('POST', url + params); </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;"><br /></div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded'); </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;xhr.responseType = 'blob'; </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;"><br /></div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;xhr.onreadystatechange = function() { </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (xhr.readyState == XMLHttpRequest.DONE &amp;&amp; xhr.status &gt;= 400) { </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;let ress = xhr.response; </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;"><br /></div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (typeof res.errorCode !== 'undefined') { </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;reject(new Error('Something went wrong...)); </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;"><br /></div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (xhr.readyState == XMLHttpRequest.DONE &amp;&amp; xhr.status == 200) { </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;let res = xhr.response; </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resolve(res);</div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// do something with response </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// let blobUrl = window.URL.createObjectURL(blob); </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// resolve(blobUrl);</div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;"><br /></div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if (xhr.readyState == 2) { </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// do something at HEADERS_RECEIVED state </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// eg. setting responseType, setting ui etc </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// xhr.responseType = 'json'; </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;} </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp; </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;// you can also listen for onload and onerror events <br />&nbsp; &nbsp; // instead of using onreadystatechange</div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;xhr.onload = function() { </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;// do something with response </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;let res = xhr.response; </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resolve(res);</div><div><span style="color: #333333; font-family: &quot;monaco&quot; , &quot;menlo&quot; , &quot;consolas&quot; , &quot;courier new&quot; , monospace;"><span style="font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;}; </span></span><br /><br /><span style="color: #333333; font-family: &quot;monaco&quot; , &quot;menlo&quot; , &quot;consolas&quot; , &quot;courier new&quot; , monospace;"><span style="font-size: 12px;">&nbsp; &nbsp; xhr.onerror = function() {</span></span><br /><span style="color: #333333; font-family: &quot;monaco&quot; , &quot;menlo&quot; , &quot;consolas&quot; , &quot;courier new&quot; , monospace;"><span style="font-size: 12px;">&nbsp; &nbsp; &nbsp; &nbsp;reject(new Error('error'));</span></span><br /><span style="color: #333333; font-family: &quot;monaco&quot; , &quot;menlo&quot; , &quot;consolas&quot; , &quot;courier new&quot; , monospace;"><span style="font-size: 12px;">&nbsp; &nbsp; };</span></span></div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;"><br /></div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;// send request </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;body = JSON.stringify({ params });</div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;&nbsp;&nbsp;xhr.send(body); </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">&nbsp;&nbsp;}) </div><div style="color: #333333; font-family: monaco, menlo, consolas, &quot;courier new&quot;, monospace; font-size: 12px;">}&nbsp;</div></div><br />Note:<br />I have also created <a href="https://groups.google.com/a/chromium.org/forum/#!mydiscussions/chromium-extensions/vHUWDtHf9Dc" target="_blank">a post in chromium extension discussion group</a>. You can check it out and see if there is any update from chromium.<br /><br />Thank you for reading!<br /><br />